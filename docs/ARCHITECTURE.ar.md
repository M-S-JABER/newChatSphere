# نظرة عامة على البنية

ChatSphere منصة مراسلة شاملة تشبه واتساب ويب.
تنقسم إلى ثلاث طبقات رئيسية: العميل، الخادم، وقاعدة البيانات.

## المكونات الأساسية
- العميل: React + Vite + Tailwind لعرض المحادثات والرسائل وأدوات الإدارة.
- الخادم: Express API + WebSocket للتحديثات الفورية والويبهوك.
- قاعدة البيانات: PostgreSQL مُدارة عبر Drizzle ORM.
- المزوّد: تكامل Meta WhatsApp Cloud API.
- الوسائط: استقبال الملفات ومعالجتها وتسليمها عبر روابط موقّعة.

## تدفق الطلبات
1. المتصفح يرسل طلبات API إلى `/api/*`.
2. مسارات Express تتحقق من المدخلات وتقرأ/تكتب في التخزين.
3. تغييرات قاعدة البيانات تُعاد إلى العميل.
4. الخادم يبث التحديثات عبر WebSocket للحفاظ على تزامن الواجهة.

## تدفق الرسائل الواردة
1. Meta ترسل webhook إلى `/webhook/meta`.
2. الخادم يتحقق من التوقيع ويحلل الأحداث.
3. الرسائل تُحفظ في قاعدة البيانات.
4. تُنشأ مدخلات الوسائط كـ pending.
5. الخادم يبث `message_incoming` لعملاء WebSocket.

## تدفق معالجة الوسائط
1. حدث الويبهوك يتضمن بيانات الوسائط.
2. الخادم ينزّل الوسائط من Meta.
3. الملفات تُخزن تحت `uploads/`.
4. تُنشأ الصور المصغرة (للصور والفيديو).
5. يتم تحديث بيانات الوسائط في قاعدة البيانات.

للتفاصيل راجع:
- docs/media-pipeline.md
- docs/media-operations.md

## تدفق الرسائل الصادرة
1. المستخدم يرسل رسالة عبر الواجهة.
2. العميل يستدعي `/api/message/send`.
3. الخادم يرسلها إلى Meta Cloud API.
4. الرسالة تُحفظ محليًا.
5. الخادم يبث `message_outgoing`.

## التحديثات الفورية
اتصالات WebSocket تستمع لأحداث مثل:
- message_incoming
- message_outgoing
- message_media_updated
- message_deleted

راجع docs/WEBSOCKET.md لمعرفة الحمولة.

## المصادقة
الجلسات تعتمد على الكوكيز عبر Passport.
دور المسؤول يقيّد نقاط الإدارة والواجهة.

## واجهة المكالمات
واجهة المكالمات تعمل على العميل فقط حاليًا.
لا تبدأ مكالمة حقيقية عبر Meta وهي مجرد غلاف تجربة المستخدم.
