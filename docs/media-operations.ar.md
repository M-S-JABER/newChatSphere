# دليل تشغيل الوسائط

## تدوير بيانات الاعتماد

- **رمز الوصول / رقم هاتف واتساب**
  1. حدّث حساب واتساب المخزن عبر لوحة الإدارة أو `storage.setDefaultWhatsappInstance`.
  2. أعد نشر/تشغيل الخادم ليتم التقاط البيانات من قبل عمال الخلفية.
  3. تحقق من الويبهوك بإرسال صورة؛ وافحص السجلات لرؤية
     `message_media_updated` للتأكد من نجاح المعالجة.

- **FILES_SIGNING_SECRET**
  - دوّر القيمة بوضع قيمة جديدة في البيئة ثم إعادة تشغيل الخادم.
  - جميع الروابط الموقّعة السابقة تصبح غير صالحة فورًا؛ والواجهة تقوم بتحديث
    الروابط تلقائيًا في التحديث القادم أو حدث WebSocket.

## مسح الوسائط المخزنة مؤقتًا

- **تنظيف القرص**: الوسائط موجودة تحت `uploads/incoming` (واتساب) و
  `uploads/outbound` (رفع المشغّل). احذف الملفات القديمة بعد التأكد من أن
  إدخالات `messages.media.storage` لم تعد مطلوبة.
- **كاش التطبيق**: العملاء يطلبون روابط موقّعة جديدة دائمًا، لذلك لا تحتاج
  إلى خطوات إضافية لمسح الكاش.

## التعامل مع فشل الاستيراد

1. افحص السجلات لأخطاء `Failed to ingest WhatsApp media`. المخرجات تتضمن
   `conversationId` و `messageId` وكود استجابة المزوّد.
2. الواجهة ستعرض شارة "Attachment unavailable" مع نص الخطأ.
3. لإعادة محاولة التنزيل يدويًا، اضبط `messages.media.status='pending'`
   للسجل المتأثر ثم أعد تشغيل الخادم (أو نفّذ إعادة تشغيل كاملة)؛ العامل
   سيعيد المحاولة عند إعادة تشغيل الويبهوك.

## خطوات استكشاف الأخطاء

- **روابط واتساب منتهية**: عامل الاستيراد يعيد جلب بيانات التعريف قبل كل
  تنزيل. إذا أعاد 401 تحقق من صحة رمز الوصول.
- **تعطل خدمة المعاينة**: إذا فشل `sharp`، يتم وضع الوسائط كـ `failed` مع
  إبقاء الملف الأصلي متاحًا للتنزيل. راقب السجلات وأعد النشر بعد الإصلاح.
- **مرفقات كبيرة**: الملفات الأكبر من `MEDIA_MAX_ORIGINAL_BYTES` يتم تجاوزها
  عن قصد. الواجهة ما زالت تعرض بطاقة التنزيل مع تحذير.
- **أخطاء التوقيع على /media**: تأكد أن العميل يستخدم أحدث رابط موقّع.
  راجع وقت الخادم وتطابق `FILES_SIGNING_SECRET` مع القيمة المنشورة.
