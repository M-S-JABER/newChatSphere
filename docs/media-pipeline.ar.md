# نظرة عامة على مسار الوسائط

هذا المستند يوضح التدفق الكامل لوسائط واتساب الواردة وكيف يتم تجهيز الملفات لواجهة الدردشة.

## التدفق العام

1. **استقبال الويبهوك**
   - `/webhook/meta` يتحقق من توقيع Meta ويطبع الحمولة ويزيل التكرارات عبر
     `providerMessageId`.
   - يتم إنشاء سجل `messages.media` بحالة pending مع بيانات المصدر دون مسارات
     ملفات بعد. عملاء WebSocket يحصلون على فقاعة فورية مع حالة تحميل.

2. **صف معالجة الوسائط**
   - `ingestWhatsappMedia` يجلب بيانات الوسائط من Graph ويعيد المحاولة عند
     الإخفاقات المؤقتة ويطبق حدود الحجم ثم ينزّل الملف باستخدام رمز الوصول.
   - تُحفظ الملفات تحت `uploads/incoming/original` بأسماء آمنة.

3. **إنشاء الصور المصغرة**
   - الصور (JPG/PNG/WEBP/HEIC) وملفات PDF تمر عبر `sharp` لتصحيح الاتجاه
     وإنشاء المصغرات (`uploads/incoming/thumbnails`).
   - المعاينات غير المدعومة تعرض أيقونات نوع الملف على العميل.

4. **الحفظ والكاش**
   - `messages.media.storage` يخزن مواقع الملفات النسبية؛ قاعدة البيانات لا تحفظ
     روابط موقّعة. تُحدث البيانات (النوع، الحجم، التحقق، العرض/الارتفاع...) بشكل ذري.
   - عند النجاح تتم إعادة بث الرسالة عبر WebSocket كـ `message_media_updated`.

5. **التسليم**
   - الملفات تُخدم عبر `GET /media/*` وتتطلب توقيعًا صالحًا يتم توليده بواسطة
     `buildSignedMediaPath` (المدة الافتراضية 15 دقيقة). يتم إصدار الروابط
     الموقّعة مع كل استجابة API لتفادي الروابط القديمة.
   - عميل React يقوم بتحميل المصغرات تدريجيًا ويعرض عناصر انتظار أثناء المعالجة
     ويفتح الأصل في تبويب جديد.

## الرفع الصادر

- رفع المشغّل يُحفظ تحت `uploads/outbound/original` عبر Multer.
- واجهة الرفع تُعيد رابط `/media/...` موقّع؛ وعند إرسال الرسالة يعاد توقيعه
  في الخادم قبل تمريره إلى واتساب.
- سجلات الرسائل الصادرة تستخدم نفس بنية `messages.media` ليتم عرضها بنفس النمط.

## ملاحظات أمنية

- `FILES_SIGNING_SECRET` مطلوب. عند التدوير يجب إعادة تشغيل الخادم ليتم توقيع
  والتحقق من الروابط بالقيمة الجديدة.
- لا يتم كشف روابط Graph الخام؛ فقط الروابط الموقّعة المستضافة على الخادم
  تُرسل للواجهة أو إلى Meta.
